<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synced Metronome</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        #metronomeCircle {
            width: 50px;
            height: 50px;
            background-color: red;
            border-radius: 50%;
            display: inline-block;
            margin-top: 20px;
            transition: transform 0.05s ease;
        }
    </style>
</head>
<body>
    <h1>Synced Metronome</h1>
    <label for="bpmInput">Tempo (BPM):</label>
    <input type="number" id="bpmInput" min="0" max="400" value="120">
    <button id="startButton">Start Metronome</button>
    <button id="stopButton" disabled>Stop Metronome</button>
    <div id="metronomeCircle"></div>
    
    <script>
        let audioBuffer;
        let metronomeRunning = false;
        let metronomeTimeout;
        let audioContext;
        
        async function getNetworkTime() {
            const start = performance.now();
            const response = await fetch("https://timeapi.io/api/Time/current/zone?timeZone=UTC");
            const end = performance.now();
            const rtt = (end - start) / 2; // Round-trip time
            const data = await response.json();
            
            const serverTime = new Date(data.dateTime).getTime();
            return serverTime + rtt; // Adjust for network latency
        }

        async function createClickBuffer(audioContext) {
            const sampleRate = audioContext.sampleRate;
            const duration = 0.01; // Shorter duration for a crisper click
            const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);
            const channelData = buffer.getChannelData(0);
            
            for (let i = 0; i < channelData.length; i++) {
                channelData[i] = Math.exp(-i / (sampleRate * 0.002)) * Math.sin(2 * Math.PI * 3000 * (i / sampleRate));
            }
            return buffer;
        }

        async function startMetronome(bpm) {
            if (metronomeRunning) return;
            metronomeRunning = true;
            document.getElementById("startButton").disabled = true;
            document.getElementById("stopButton").disabled = false;
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (!audioBuffer) {
                audioBuffer = await createClickBuffer(audioContext);
            }
            const beatInterval = 60000 / bpm; // Interval between beats in ms

            const networkTime = await getNetworkTime();
            const now = Date.now();
            const offset = networkTime - now;
            
            const currentHourStart = Math.floor(networkTime / 3600000) * 3600000;
            let nextBeatTime = currentHourStart;
            while (nextBeatTime < networkTime) {
                nextBeatTime += beatInterval;
            }
            
            function scheduleNextBeat() {
                if (!metronomeRunning) return;
                const timeUntilNextBeat = nextBeatTime - (Date.now() + offset);
                metronomeTimeout = setTimeout(() => {
                    playClick(audioContext);
                    animateCircle();
                    nextBeatTime += beatInterval;
                    scheduleNextBeat();
                }, timeUntilNextBeat);
            }
            
            scheduleNextBeat();
        }

        function stopMetronome() {
            metronomeRunning = false;
            clearTimeout(metronomeTimeout);
            document.getElementById("startButton").disabled = false;
            document.getElementById("stopButton").disabled = true;
        }

        function playClick(audioContext) {
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
        }

        function animateCircle() {
            const circle = document.getElementById("metronomeCircle");
            circle.style.transform = "scale(1.3)";
            setTimeout(() => {
                circle.style.transform = "scale(1)";
            }, 50);
        }

        document.getElementById("startButton").addEventListener("click", async () => {
            const bpm = parseInt(document.getElementById("bpmInput").value, 10);
            if (bpm >= 0 && bpm <= 400) {
                startMetronome(bpm);
            }
        });
        
        document.getElementById("stopButton").addEventListener("click", stopMetronome);
    </script>
</body>
</html>
