<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synced Metronome</title>
</head>
<body>
    <h1>Synced Metronome</h1>
    <label for="bpmInput">Tempo (BPM):</label>
    <input type="number" id="bpmInput" min="0" max="400" value="120">
    <button id="startButton">Start Metronome</button>
    
    <script>
        let audioBuffer;
        
        async function getNetworkTime() {
            const start = performance.now();
            const response = await fetch("https://timeapi.io/api/Time/current/zone?timeZone=UTC");
            const end = performance.now();
            const rtt = (end - start) / 2; // Round-trip time
            const data = await response.json();
            
            const serverTime = new Date(data.dateTime).getTime();
            return serverTime + rtt; // Adjust for network latency
        }

        async function createClickBuffer(audioContext) {
            const sampleRate = audioContext.sampleRate;
            const duration = 0.05; // 50ms click sound
            const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);
            const channelData = buffer.getChannelData(0);
            
            for (let i = 0; i < channelData.length; i++) {
                channelData[i] = Math.sin(2 * Math.PI * 1000 * (i / sampleRate));
            }
            return buffer;
        }

        async function startMetronome(bpm) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (!audioBuffer) {
                audioBuffer = await createClickBuffer(audioContext);
            }
            const beatInterval = 60000 / bpm; // Interval between beats in ms

            const networkTime = await getNetworkTime();
            const now = Date.now();
            const offset = networkTime - now;
            
            const currentHourStart = Math.floor(networkTime / 3600000) * 3600000;
            let nextBeatTime = currentHourStart;
            while (nextBeatTime < networkTime) {
                nextBeatTime += beatInterval;
            }
            
            function scheduleNextBeat() {
                const timeUntilNextBeat = nextBeatTime - (Date.now() + offset);
                setTimeout(() => {
                    playClick(audioContext);
                    nextBeatTime += beatInterval;
                    scheduleNextBeat();
                }, timeUntilNextBeat);
            }
            
            scheduleNextBeat();
        }

        function playClick(audioContext) {
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
        }

        document.getElementById("startButton").addEventListener("click", async () => {
            const bpm = parseInt(document.getElementById("bpmInput").value, 10);
            if (bpm >= 0 && bpm <= 400) {
                startMetronome(bpm);
            }
        });
    </script>
</body>
</html>
